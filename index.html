<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è–æ¯æŒ‘æˆ°è³½ - é›²ç«¯ç©©å®šç‰ˆ</title>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>
    <style>
        :root {
            --gold: #f1c40f;
            --red: #8b0000;
            --dark-bg: #1a0505;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            margin: 0; background-color: var(--dark-bg); color: var(--gold);
            font-family: "PingFang TC", "Microsoft JhengHei", serif;
            display: flex; flex-direction: column; min-height: 100vh;
        }

        /* ä¸»æŒäººæ§åˆ¶å° */
        #admin-panel {
            background: #2d0a0a; border-bottom: 2px solid var(--gold);
            padding: 15px; display: none; text-align: center;
        }
        .admin-btn { background: #27ae60; color: white; border: none; padding: 10px 15px; margin: 5px; border-radius: 5px; cursor: pointer; font-weight: bold; }

        /* å…¥å£ç•«é¢ */
        #login-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle, #4a1010 0%, #0d0202 100%);
            z-index: 2000; display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .input-group { background: rgba(45,10,10,0.9); padding: 30px; border-radius: 20px; border: 2px solid var(--gold); text-align: center; }

        /* éŠæˆ²ä¸»å€ */
        .main-container { flex: 1; padding: 20px; text-align: center; }
        .stage { perspective: 1200px; height: 180px; display: flex; justify-content: center; align-items: center; gap: 30px; margin: 20px 0; }
        .cup { width: 60px; height: 100px; position: relative; transform-style: preserve-3d; }
        .cup-side { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; border-radius: 50% 10% 10% 50% / 50% 10% 10% 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1.2rem; }
        .cup-front { background: linear-gradient(135deg, #b30000, #600000); transform: rotateY(0deg); color: white; }
        .cup-back { background: linear-gradient(135deg, #ffedbc, #edc453); transform: rotateY(180deg); color: #8a4b00; }
        
        @keyframes toss {
            0% { transform: translateY(0) rotateX(0); }
            50% { transform: translateY(-200px) rotateX(720deg) rotateY(360deg); }
            100% { transform: translateY(0) rotateX(var(--final-x)) rotateY(0deg); }
        }
        .animating { animation: toss 1.2s cubic-bezier(0.1, 0.8, 0.3, 1.2) forwards; }

        .btn-toss {
            background: linear-gradient(180deg, #f1c40f, #b8860b); color: #1a0505;
            padding: 15px 50px; font-size: 1.5rem; font-weight: bold; border: none; border-radius: 50px; cursor: pointer;
        }
        .btn-toss:disabled { background: #444; color: #888; cursor: not-allowed; }
        
        .history-box { width: 100%; max-width: 400px; margin: 20px auto; background: rgba(255,255,255,0.05); border-radius: 10px; padding: 10px; font-size: 0.9rem; }
        .history-row { display: flex; justify-content: space-between; padding: 5px; border-bottom: 1px solid rgba(255,255,255,0.1); }
    </style>
</head>
<body>

<div id="admin-panel">
    <h3>ğŸ‘‘ ä¸»æŒäººæ§åˆ¶å°</h3>
    <div id="online-list">ç­‰å¾…ä¿¡çœ¾åŠ å…¥...</div>
    <div style="margin-top: 10px;">
        <button class="admin-btn" onclick="setControl(true)">âœ… é–‹å•Ÿç•¶å‰æ¬Šé™</button>
        <button class="admin-btn" style="background:#c0392b" onclick="setControl(false)">âŒ æ”¶å›æ¬Šé™</button>
        <button class="admin-btn" style="background:#555" onclick="clearAll()">ğŸ§¹ é‡ç½®å…¨å ´</button>
    </div>
</div>

<div id="login-overlay">
    <div class="input-group">
        <h2 style="color:var(--gold)">è–æ¯æŒ‘æˆ°è³½</h2>
        <input type="text" id="user-input" placeholder="è«‹è¼¸å…¥å¤§å" style="padding:10px; width:180px; text-align:center; font-size:1.2rem; border-radius:5px; border:1px solid var(--gold); outline:none;">
        <br><br>
        <button class="btn-toss" onclick="joinGame()">é€²å…¥æœƒå ´</button>
    </div>
</div>

<div class="main-container">
    <h2 id="display-name">ä¿¡çœ¾ï¼šå°šæœªåŠ å…¥</h2>
    <div style="font-size: 2.5rem; color: #ff4d4d; font-weight: bold;">è–æ¯ï¼š<span id="count">0</span></div>
    
    <div class="stage">
        <div id="c1" class="cup"><div class="cup-side cup-front">é™°</div><div class="cup-side cup-back">é™½</div></div>
        <div id="c2" class="cup"><div class="cup-side cup-front">é™°</div><div class="cup-side cup-back">é™½</div></div>
    </div>

    <div id="status-msg" style="height:30px; margin-bottom:15px; font-size:1.2rem; color: #fff;"></div>
    <button id="toss-btn" class="btn-toss" onclick="handleToss()" disabled>ç­‰å¾…é»å</button>

    <div class="history-box">
        <div style="border-bottom: 1px solid var(--gold); margin-bottom: 5px;">ğŸ“œ å…¨å ´åŒæ­¥ç´€éŒ„</div>
        <div id="history-content"></div>
    </div>
</div>

<script>
    // æ‚¨çš„ Firebase é…ç½® (å·²æ ¡å°)
    const firebaseConfig = {
        apiKey: "AIzaSyD2Jw4ZZlCKzL0eLfH5znZidiUXpNjLTi0",
        authDomain: "templegame-ae6b2.firebaseapp.com",
        databaseURL: "https://templegame-ae6b2-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "templegame-ae6b2",
        storageBucket: "templegame-ae6b2.firebasestorage.app",
        messagingSenderId: "32887114990",
        appId: "1:32887114990:web:490dd8bd971211002c77ff"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const isAdmin = new URLSearchParams(window.location.search).get('admin') === 'y';
    let myName = "";
    let myShengCount = 0;

    if (isAdmin) {
        document.getElementById('admin-panel').style.display = 'block';
        listenOnline();
    }

    function joinGame() {
        const name = document.getElementById('user-input').value.trim();
        if(!name) return alert("è«‹è¼¸å…¥å¤§åï¼");
        myName = name;
        document.getElementById('display-name').innerText = "ä¿¡çœ¾ï¼š" + myName;
        document.getElementById('login-overlay').style.display = 'none';
        
        // è¨»å†Šåœ¨ç·š
        const ref = db.ref('online/' + myName);
        ref.set(true);
        ref.onDisconnect().remove();
    }

    // ç›£è½æ¬Šé™ (æ ¸å¿ƒä¿®æ­£é»)
    db.ref('gameState').on('value', (snap) => {
        const data = snap.val() || {};
        const activeUser = data.activeUser || "";
        const canToss = data.canToss || false;

        const msg = document.getElementById('status-msg');
        const btn = document.getElementById('toss-btn');

        if (myName === activeUser) {
            if (canToss) {
                msg.innerText = "âœ¨ ç¥æ˜å‡†è¨±ï¼Œè«‹æ“²ç¬…ï¼";
                btn.disabled = false;
            } else {
                msg.innerText = "â³ è«‹ç­‰å¾…ä¸»æŒäººé–‹å•Ÿæ¬Šé™";
                btn.disabled = true;
            }
        } else {
            msg.innerText = activeUser ? `è¼ªåˆ° ${activeUser} æ“²ç¬…ä¸­` : "ç­‰å¾…ä¸»æŒäººé»å...";
            btn.disabled = true;
        }
    });

    // ç›£è½ç´€éŒ„
    db.ref('history').limitToLast(8).on('value', (snap) => {
        const data = snap.val();
        let html = "";
        if (data) {
            Object.values(data).reverse().forEach(v => {
                html += `<div class="history-row"><span>${v.name}</span><span style="color:${v.res==='è–æ¯'?'#00ff00':'#ff4d4d'}">${v.res}</span></div>`;
            });
        }
        document.getElementById('history-content').innerHTML = html;
    });

    function handleToss() {
        const btn = document.getElementById('toss-btn');
        btn.disabled = true;
        
        const r1 = Math.random() > 0.5 ? 0 : 180;
        const r2 = Math.random() > 0.5 ? 0 : 180;

        const c1 = document.getElementById('c1');
        const c2 = document.getElementById('c2');
        
        c1.style.setProperty('--final-x', (1440 + r1) + 'deg');
        c2.style.setProperty('--final-x', (1440 + r2) + 'deg');
        
        c1.classList.remove('animating'); c2.classList.remove('animating');
        void c1.offsetWidth;
        c1.classList.add('animating'); c2.classList.add('animating');

        setTimeout(() => {
            let res = "";
            if (r1 !== r2) {
                res = "è–æ¯";
                myShengCount++;
                document.getElementById('count').innerText = myShengCount;
                btn.disabled = false;
            } else {
                res = (r1 === 0) ? "ç¬‘æ¯" : "é™°æ¯";
                // å¤±æ•—å¾Œé€šçŸ¥é›²ç«¯é–å®š
                db.ref('gameState').update({ canToss: false });
            }
            document.getElementById('status-msg').innerText = "ã€ " + res + " ã€‘";
            db.ref('history').push({ name: myName, res: res, time: Date.now() });
        }, 1200);
    }

    // ä¸»æŒäººåŠŸèƒ½
    function listenOnline() {
        db.ref('online').on('value', (snap) => {
            const list = snap.val() || {};
            let html = "åœ¨ç·šä¿¡çœ¾ï¼š";
            Object.keys(list).forEach(p => {
                html += `<button class="admin-btn" style="background:#8e44ad" onclick="selectPlayer('${p}')">${p}</button>`;
            });
            document.getElementById('online-list').innerHTML = html;
        });
    }
    function selectPlayer(name) {
        db.ref('gameState').set({ activeUser: name, canToss: false });
    }
    function setControl(val) {
        db.ref('gameState').update({ canToss: val });
    }
    function clearAll() {
        if(confirm("ç¢ºå®šæ¸…ç©ºå…¨å ´æ•¸æ“šï¼Ÿ")) db.ref('/').remove();
    }
</script>
</body>
</html>