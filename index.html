<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è–æ¯æŒ‘æˆ°è³½ - åŠŸå¾·æ’è¡Œæ¦œç‰ˆ</title>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>
    <style>
        :root { --gold: #f1c40f; --red: #8b0000; --dark: #1a0505; }
        body { margin: 0; background: var(--dark); color: var(--gold); font-family: sans-serif; display: flex; overflow-x: hidden; }

        /* å·¦å´åŠŸå¾·æ¦œ (PCç‰ˆé¡¯ç¤ºï¼Œæ‰‹æ©Ÿç‰ˆéš±è—æˆ–ç½®åº•) */
        #leaderboard { 
            width: 250px; background: rgba(20,0,0,0.8); border-right: 2px solid var(--gold); 
            height: 100vh; overflow-y: auto; padding: 15px; flex-shrink: 0;
        }
        .rank-item { display: flex; justify-content: space-between; padding: 8px; border-bottom: 1px solid #441010; font-size: 0.9rem; }
        
        /* ä¸»éŠæˆ²å€ */
        .main-content { flex: 1; display: flex; flex-direction: column; align-items: center; position: relative; }

        /* ä¸»æŒäººé¢æ¿ */
        #admin-panel { width: 100%; background: #2d0a0a; border-bottom: 2px solid var(--gold); padding: 10px; display: none; text-align: center; }
        .queue-box { border: 1px dashed var(--gold); margin: 5px; padding: 5px; border-radius: 5px; }

        /* 3D ç¬…æ¯å€ */
        .stage { perspective: 1200px; height: 160px; display: flex; justify-content: center; align-items: center; gap: 20px; margin: 20px 0; }
        .cup { width: 55px; height: 90px; position: relative; transform-style: preserve-3d; }
        .cup-side { position: absolute; inset: 0; backface-visibility: hidden; border-radius: 50% 10% 10% 50% / 50% 10% 10% 50%; display: flex; align-items: center; justify-content: center; }
        .cup-front { background: #b30000; color: white; transform: rotateY(0deg); }
        .cup-back { background: #edc453; color: #8a4b00; transform: rotateY(180deg); }
        
        @keyframes toss {
            0% { transform: translateY(0) rotateX(0); }
            50% { transform: translateY(-200px) rotateX(1080deg); }
            100% { transform: translateY(0) rotateX(var(--final-x)); }
        }
        .animating { animation: toss 1s cubic-bezier(0.17, 0.67, 0.83, 0.67) forwards; }

        .btn-toss { background: linear-gradient(180deg, #f1c40f, #b8860b); color: #1a0505; padding: 12px 40px; font-size: 1.4rem; font-weight: bold; border: none; border-radius: 50px; cursor: pointer; }
        .btn-toss:disabled { background: #444; color: #888; }

        /* åº•éƒ¨æœ€è¿‘ç´€éŒ„ */
        .recent-history { width: 90%; max-width: 400px; margin-top: 15px; background: rgba(255,255,255,0.05); border-radius: 10px; padding: 10px; }

        /* éŸ¿æ‡‰å¼ï¼šæ‰‹æ©Ÿç‰ˆå°‡æ¦œå–®éš±è—æ”¹ç‚ºæŒ‰éˆ•é–‹å•Ÿ */
        @media (max-width: 768px) {
            #leaderboard { position: fixed; left: -250px; z-index: 3000; transition: 0.3s; }
            #leaderboard.open { left: 0; }
        }
    </style>
</head>
<body>

<div id="leaderboard">
    <h3 style="text-align: center; color: var(--gold);">ğŸ† è–æ¯åŠŸå¾·æ¦œ</h3>
    <div id="rank-list">è¼‰å…¥ä¸­...</div>
</div>

<div class="main-content">
    <div id="admin-panel">
        <div class="queue-box">
            <b>â³ ç­‰å¾…æ’éšŠï¼š</b> <div id="admin-queue"></div>
        </div>
        <div>
            <button onclick="db.ref('gameState').update({canToss:true})" style="background:#27ae60; color:white; padding:5px 10px;">âœ… é–‹å•Ÿæ“²ç¬…</button>
            <button onclick="db.ref('gameState').update({canToss:false})" style="background:#c0392b; color:white; padding:5px 10px;">âŒ æš«åœ(æ”¶å›æ¬Šé™)</button>
        </div>
    </div>

    <div style="text-align:center; padding: 20px;">
        <h2 id="current-name">æ­¡è¿è’è‡¨</h2>
        <div style="font-size: 2.5rem; font-weight: bold;">ç›®å‰è–æ¯ï¼š<span id="sheng-count">0</span></div>
        
        <div class="stage">
            <div id="c1" class="cup"><div class="cup-side cup-front">é™°</div><div class="cup-side cup-back">é™½</div></div>
            <div id="c2" class="cup"><div class="cup-side cup-front">é™°</div><div class="cup-side cup-back">é™½</div></div>
        </div>
        
        <div id="status-msg" style="height:30px; margin-bottom:10px;"></div>
        <button id="toss-btn" class="btn-toss" onclick="handleToss()" disabled>ç­‰å¾…æ“²ç¬…</button>
    </div>

    <div class="recent-history">
        <div style="text-align:center; font-size:0.8rem; border-bottom:1px solid #444;">ğŸ“œ æœ€è¿‘ 10 æ¬¡æˆæœ</div>
        <div id="recent-list"></div>
    </div>
</div>

<script>
    // Firebase é…ç½® (å¥—ç”¨æ‚¨çš„ API Key)
    const firebaseConfig = { /* ...æ‚¨æä¾›çš„é…ç½®... */ };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const isAdmin = new URLSearchParams(window.location.search).get('admin') === 'y';
    
    let myName = "";
    let mySheng = 0;

    // é—œéµé‚è¼¯ 1ï¼šç›£è½æŒ‰éˆ•æ–‡å­—èˆ‡ç‹€æ…‹
    db.ref('gameState').on('value', snap => {
        const state = snap.val() || {};
        const active = state.activeUser || "";
        const can = state.canToss || false;
        const btn = document.getElementById('toss-btn');

        if (myName === active) {
            // æ˜¯ç•¶å‰ä½¿ç”¨è€…
            if (can) {
                btn.innerText = "æ“² ç¬…";
                btn.disabled = false;
            } else {
                btn.innerText = "ç­‰å¾…æ“²ç¬…";
                btn.disabled = true;
            }
        } else {
            // éç•¶å‰ä½¿ç”¨è€…
            btn.innerText = "ç­‰å¾…æ“²ç¬…";
            btn.disabled = true;
        }
    });

    // é—œéµé‚è¼¯ 2ï¼šé›™ä½‡åˆ—èˆ‡æ’è¡Œæ¦œ
    // ç›£è½æ’è¡Œæ¦œ (åŠŸå¾·æ¦œ - ä¾è–æ¯æ•¸æ’åº)
    db.ref('leaderboard').orderByValue().limitToLast(20).on('value', snap => {
        let ranks = [];
        snap.forEach(child => {
            ranks.push({ name: child.key, count: child.val() });
        });
        ranks.reverse(); // ç”±å¤§åˆ°å°
        let html = "";
        ranks.forEach((r, i) => {
            html += `<div class="rank-item"><span>${i+1}. ${r.name}</span><b>${r.count}æ¬¡</b></div>`;
        });
        document.getElementById('rank-list').innerHTML = html;
    });

    // é—œéµé‚è¼¯ 3ï¼šä¸»æŒäººç«¯çš„æ’éšŠåå–®
    if (isAdmin) {
        document.getElementById('admin-panel').style.display = 'block';
        db.ref('queue').on('value', snap => {
            const list = snap.val() || {};
            let html = "";
            Object.keys(list).forEach(p => {
                html += `<button onclick="startPlayer('${p}')" style="margin:2px; padding:4px;">${p}</button>`;
            });
            document.getElementById('admin-queue').innerHTML = html;
        });
    }

    function startPlayer(name) {
        // è¨­å®šé€²è¡Œä¸­ï¼Œä¸¦å¾æ’éšŠä¸­ç§»é™¤ï¼ŒåŠ å…¥å·²åƒåŠ ç´€éŒ„ï¼ˆæˆ–æ–¼çµæŸæ™‚åŠ å…¥ï¼‰
        db.ref('gameState').set({ activeUser: name, canToss: false });
        db.ref('queue/' + name).remove();
        db.ref('shengTemp').set(0); // é‡ç½®æš«å­˜è¨ˆæ•¸
    }

    function handleToss() {
        // ... (3D ç‰©ç†å‹•ç•«é‚è¼¯) ...
        // æˆåŠŸè–æ¯æ™‚ï¼š
        // mySheng++;
        // db.ref('leaderboard/' + myName).set(mySheng); // å³æ™‚æ›´æ–°åŠŸå¾·æ¦œ
    }
</script>
</body>
</html>
